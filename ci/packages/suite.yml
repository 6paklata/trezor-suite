.run_on:
    rules: &rules_definition
        - if: '$CI_COMMIT_REF_PROTECTED'
          when: always
        - if: '$CI_COMMIT_REF_NAME == "develop"'
          when: always
        - changes:
            - ci/**/*
            - suite/**/*
          when: always
        - when: manual

.dependencies:
    dependencies: &dependencies_definition
        - install and build

suite lint:
    stage: lint and prettier
    rules: *rules_definition
    script:
        - yarn workspace @trezor/suite lint
    dependencies: *dependencies_definition

suite detect l10n duplicities:
    stage: lint and prettier
    rules: *rules_definition
    script:
        # for some reason we cannot run it using simple yarn command https://github.com/trezor/trezor-suite/issues/774
        - cd packages/suite && NODE_ENV=translations npx babel src/**/*.{tsx,ts} && npx node ../../packages/translations-manager/lib/cli.js merge-msgs
    dependencies: *dependencies_definition

suite type check:
    stage: typescript type check
    rules: *rules_definition
    script:
        - yarn workspace @trezor/suite type-check
    dependencies: *dependencies_definition

suite test unit:
    stage: unit testing
    rules: *rules_definition
    script:
        - yarn workspace @trezor/suite-data copy-static-files
        - yarn workspace @trezor/suite test:unit
    dependencies: *dependencies_definition

suite test integration:
    only:
        - schedules
    stage: integration testing
    script:
        - yarn workspace @trezor/suite test-health
    dependencies: *dependencies_definition    
